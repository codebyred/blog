<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="My personal blog"><link rel=stylesheet href=/blog/styles/style.css><link rel=icon href=/blog/images/favicon.png><title>Lvm Snapshot Backup and Restore Guide</title></head><body><div class=container><nav class=navbar><div class=logo><a href=/blog>CodebyRed</a></div><div class=links><div class=toggle><svg width="20" height="20" viewBox="-.14 0 20.03 20.03" fill="#000"><g id="moon-alt" transform="translate(-2.25 -2)"><path id="secondary" fill="#ffe01b" d="M21 12A9 9 0 013.25 14.13 6.9 6.9.0 008 16 7 7 0 0011.61 3H12a9 9 0 019 9z"/></g></svg><div class=ball></div><svg width="20" height="20" viewBox="0 0 20 20" fill="#000"><g id="sun" transform="translate(-2 -2)"><circle id="secondary" fill="#ffe01b" cx="4" cy="4" r="4" transform="translate(8 8)"/><path id="primary" d="M12 3V4M5.64 5.64l.7.7M3 12H4m1.64 6.36.7-.7M12 21V20m6.36-1.64-.7-.7M21 12H20M18.36 5.64l-.7.7M12 8a4 4 0 104 4A4 4 0 0012 8z" fill="none" stroke="#ffe01b" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></g></svg></div><a href=https://codebyred.github.io/blog>Homepage</a>
<a href=https://codebyred.github.io/blog/tags/>Tags</a><div class=searchButton><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.77 18.3C9.2807 18.3 7.82485 17.8584 6.58655 17.031 5.34825 16.2036 4.38311 15.0275 3.81318 13.6516c-.56993-1.3759-.71905-2.89-.4285-4.35064.29055-1.46067 1.00771-2.80239 2.0608-3.85548s2.39481-1.77025 3.85548-2.0608c1.46064-.29055 2.97474-.14143 4.35064.4285s2.552 1.53507 3.3794 2.77337C17.8584 7.82485 18.3 9.2807 18.3 10.77 18.3 11.7588 18.1052 12.738 17.7268 13.6516s-.9331 1.7437-1.6323 2.4429C15.3953 16.7937 14.5652 17.3484 13.6516 17.7268S11.7588 18.3 10.77 18.3zm0-13.55001c-1.18669.0-2.34673.3519-3.33343 1.01119C6.44988 6.42046 5.68084 7.35754 5.22672 8.45389 4.77259 9.55025 4.65377 10.7566 4.88528 11.9205S5.68824 14.1535 6.52735 14.9926C7.36647 15.8317 8.43556 16.4032 9.59945 16.6347c1.16385.2315 2.37025.1127 3.46665-.3414C14.1624 15.8391 15.0995 15.0701 15.7588 14.0834 16.4181 13.0967 16.77 11.9367 16.77 10.75 16.77 9.15869 16.1379 7.63257 15.0126 6.50735 13.8874 5.38213 12.3613 4.74999 10.77 4.74999z" fill="#cbd5e1"/><path d="M20 20.75C19.9015 20.7504 19.8038 20.7312 19.7128 20.6934 19.6218 20.6557 19.5392 20.6001 19.47 20.53L15.34 16.4C15.2075 16.2578 15.1354 16.0697 15.1388 15.8754 15.1422 15.6811 15.221 15.4958 15.3584 15.3583 15.4958 15.2209 15.6812 15.1422 15.8755 15.1388 16.0698 15.1354 16.2578 15.2075 16.4 15.34l4.13 4.13C20.6704 19.6106 20.7493 19.8012 20.7493 20 20.7493 20.1987 20.6704 20.3893 20.53 20.53 20.4608 20.6001 20.3782 20.6557 20.2872 20.6934 20.1962 20.7312 20.0985 20.7504 20 20.75z" fill="#cbd5e1"/></svg>
<span>Search</span></div></div></nav><div class=single><div class=singleHead><div class=singleHeadTexts><h1 class=singleHeadTitle>Lvm Snapshot Backup and Restore Guide</h1><p class=singleHeadDesc></p><div class=singleHeadDetail><span><a href=https://codebyred.github.io/blog/authors/redoan/>Redoan</a>
</span><a href=https://codebyred.github.io/blog/tags/linux/ class=singleCategory>Linux</a>
<a href=https://codebyred.github.io/blog/tags/backup/ class=singleCategory>Backup</a></div></div></div><div class=singleBottom><div class=singleContent><h1 id=overview>Overview</h1><p>This document explains how to perform block-level backup and restore of an LVM logical volume using:</p><ul><li><p>LVM snapshots (point-in-time consistency)</p></li><li><p>dd (block copy)</p></li><li><p>pigz (parallel compression)</p></li><li><p>ssh (secure transfer)</p></li></ul><p>This method is suitable for:</p><ul><li><p>Full system backup</p></li><li><p>Bare-metal restore scenarios</p></li><li><p>Disaster recovery preparation</p></li><li><p>Exact disk state preservation</p></li></ul><h1 id=backup-transfer-methods>Backup Transfer Methods</h1><p>Two supported transfer methods are available:</p><ol><li>Method A — SSH Streaming Pipeline</li><li>Method B — SCP File Transfer</li></ol><h1 id=environment-example>Environment Example</h1><table><thead><tr><th>Component</th><th>Value</th></tr></thead><tbody><tr><td>Volume Group</td><td>ubuntu-vg</td></tr><tr><td>Root Logical Volume</td><td>ubuntu-lv</td></tr><tr><td>Snapshot Name</td><td>root_snap</td></tr><tr><td>Backup Server</td><td>10.10.30.57</td></tr><tr><td>Backup Path</td><td>/backup</td></tr><tr><td>Compression Tool</td><td>pigz</td></tr></tbody></table><h1 id=prerequisites>Prerequisites</h1><h2 id=install-required-tools>Install Required Tools</h2><h3 id=backup-storage-server>Backup Storage Server</h3><pre tabindex=0><code>sudo apt update
sudo apt install pigz -y
</code></pre><h3 id=backup-target-server>Backup Target Server</h3><pre tabindex=0><code>sudo apt install pigz -y
</code></pre><h2 id=part-1--create-lvm-snapshot>PART 1 — Create LVM Snapshot</h2><h3 id=step-1--verify-volume-group-free-space>Step 1 — Verify Volume Group Free Space</h3><pre tabindex=0><code>sudo vgs
</code></pre><p><strong>Requirement</strong></p><p>Snapshot COW space must be available in VG free space.
Typical planning:</p><table><thead><tr><th>Workload Type</th><th>Recommended Snapshot Size</th></tr></thead><tbody><tr><td>Low write activity</td><td>5–10% of LV</td></tr><tr><td>Medium write activity</td><td>15–20%</td></tr><tr><td>High write activity</td><td>30%+</td></tr></tbody></table><h3 id=step-2--create-snapshot>Step 2 — Create Snapshot</h3><pre tabindex=0><code>sudo lvcreate -L 5G -s -n root_snap /dev/ubuntu-vg/ubuntu-lv
</code></pre><p><strong>Explanation</strong></p><table><thead><tr><th>Option</th><th>Meaning</th></tr></thead><tbody><tr><td><code>-L 5G</code></td><td>Snapshot COW storage size</td></tr><tr><td><code>-s</code></td><td>Create snapshot</td></tr><tr><td><code>-n root_snap</code></td><td>Snapshot name</td></tr></tbody></table><h3 id=step-3--verify-snapshot>Step 3 — Verify Snapshot</h3><pre tabindex=0><code>sudo lvs
</code></pre><h2 id=part-2--backup-snapshot-to-remote-server>PART 2 — Backup Snapshot to Remote Server</h2><h3 id=step-4>Step 4</h3><p><strong>Method-1: Stream Snapshot Using pigz + SSH</strong></p><p>This method streams snapshot data directly to the remote server without creating a local backup file.</p><p>Advantages</p><ul><li><p>No temporary disk usage on source</p></li><li><p>Fast for automation</p></li><li><p>Single pipeline command</p></li><li><p>Less storage required on source server</p></li></ul><p>Disadvantages</p><ul><li><p>Cannot resume if interrupted</p></li><li><p>Harder to verify mid-transfer</p></li><li><p>Requires stable network connection</p></li></ul><p>Backup Command</p><pre tabindex=0><code>sudo dd if=/dev/ubuntu-vg/root_snap bs=16M status=progress \
| pigz -1 \
| ssh root@10.10.30.57 &#34;cat &gt; /backup/root_snap.img.gz&#34;
</code></pre><p><strong>Why This Pipeline Works Well</strong></p><table><thead><tr><th>Component</th><th>Purpose</th></tr></thead><tbody><tr><td>dd</td><td>Reads raw block data</td></tr><tr><td>pigz</td><td>Parallel compression (faster than gzip)</td></tr><tr><td>ssh</td><td>Secure transport</td></tr></tbody></table><p>When To Use SSH Streaming</p><ul><li><p>Backup runs automatically (cron / automation)</p></li><li><p>Source disk space is limited</p></li><li><p>Network is reliable</p></li><li><p>Fastest transfer required</p></li></ul><p><strong>Method B — Backup Using SCP Transfer (File-Based Method)</strong></p><p>This method creates a compressed backup file locally, then transfers it using SCP.</p><p>Advantages</p><ul><li><p>Easy to verify backup before transfer</p></li><li><p>Transfer can be retried separately</p></li><li><p>Easier troubleshooting</p></li><li><p>Allows checksum validation</p></li><li><p>Supports resume using rsync (if needed later)</p></li></ul><p>Disadvantages</p><ul><li><p>Requires local storage equal to compressed backup size</p></li><li><p>Two-step process (backup + transfer)</p></li></ul><p>First run this</p><pre tabindex=0><code>sudo dd if=/dev/ubuntu-vg/root_snap bs=16M status=progress \
| pigz -1 &gt; /tmp/root_snap.img.gz
</code></pre><p>Verfiy Local Backup</p><pre tabindex=0><code>ls -lh /tmp/root_snap.img.gz
</code></pre><p>Transfer Using SCP</p><pre tabindex=0><code>scp /tmp/root_snap.img.gz root@10.10.30.57:/backup/
</code></pre><h3 id=step-5--verify-backup-file>Step 5 — Verify Backup File</h3><pre tabindex=0><code>ssh root@10.10.30.57 &#34;ls -lh /backup/root_snap.img.gz&#34;
</code></pre><h3 id=step-6--remove-snapshot-recommended>Step 6 — Remove Snapshot (Recommended)</h3><pre tabindex=0><code>sudo lvremove -y /dev/ubuntu-vg/root_snap
</code></pre><p>Why Remove Snapshot?</p><p>Snapshots slow down disk performance and consume COW storage.</p><h2 id=part-3--restore-from-backup>PART 3 — Restore from Backup</h2><p>⚠ CRITICAL WARNING</p><p>Restore overwrites the entire logical volume.
Restore overwrites the entire logical volume.</p><p>Perform restore from:</p><ul><li><p>Rescue Mode</p></li><li><p>Live ISO</p></li><li><p>Maintenance environment
Never restore while system is running from that LV.</p></li></ul><h3 id=step-7--activate-lvm-if-needed>Step 7 — Activate LVM (If Needed)</h3><pre tabindex=0><code>sudo vgchange -ay
</code></pre><h3 id=step-8--restore-snapshot-image>Step 8 — Restore Snapshot Image</h3><pre tabindex=0><code>ssh root@10.10.30.57 &#34;cat /backup/root_snap.img.gz&#34; \
| pigz -d \
| sudo dd of=/dev/ubuntu-vg/ubuntu-lv bs=16M conv=fsync status=progress
</code></pre><h3 id=step-9--flush-disk-cache>Step 9 — Flush Disk Cache</h3><pre tabindex=0><code>sync
</code></pre><h3 id=step-10--reboot>Step 10 — Reboot</h3><pre tabindex=0><code>sudo reboot
</code></pre><h1 id=storage-planning-guidelines>Storage Planning Guidelines</h1><h2 id=target-machine>Target Machine</h2><table><thead><tr><th>Requirement</th><th>Notes</th></tr></thead><tbody><tr><td>VG free space ≥ snapshot size</td><td>Required for COW</td></tr><tr><td>Snapshot size</td><td>Depends on write activity</td></tr></tbody></table><h2 id=backup-storage-server-1>Backup Storage Server</h2><table><thead><tr><th>Requirement</th><th>Notes</th></tr></thead><tbody><tr><td>Storage ≥ LV size per backup</td><td>dd creates full image</td></tr><tr><td>Large file support</td><td>ext4 / XFS recommended</td></tr><tr><td>CPU for compression</td><td>pigz benefits from multi-core</td></tr><tr><td>Network bandwidth</td><td>Impacts backup duration</td></tr></tbody></table><h2 id=example-storage-scenario>Example Storage Scenario</h2><table><thead><tr><th>Component</th><th>Size</th></tr></thead><tbody><tr><td>Root LV</td><td>15 GB</td></tr><tr><td>Snapshot mapping</td><td>15 GB (virtual)</td></tr><tr><td>Snapshot COW</td><td>5 GB</td></tr><tr><td>Compressed backup</td><td>~7–8 GB</td></tr><tr><td>3 backup retention</td><td>~21–24 GB</td></tr></tbody></table><h1 id=technical-concepts>Technical Concepts</h1><ol><li>LVM Snapshot — What It Is</li></ol><p>A snapshot is a point-in-time logical volume view.</p><pre tabindex=0><code>Live LV → continues changing
Snapshot → frozen at creation time
</code></pre><ol start=2><li>Copy-On-Write (COW) — How It Works</li></ol><p>When a block is modified:</p><pre tabindex=0><code>1. Original block copied to snapshot COW
2. New block written to main LV
</code></pre><p>This preserves snapshot integrity.</p><ol start=3><li>Snapshot Data Lifecycle Example</li></ol><table><thead><tr><th>Event</th><th>Original LV</th><th>Snapshot</th><th>COW Stored</th></tr></thead><tbody><tr><td>Initial</td><td>1</td><td>1</td><td>Empty</td></tr><tr><td>Write → 2</td><td>2</td><td>1</td><td>1</td></tr><tr><td>Write → 3</td><td>3</td><td>1</td><td>1</td></tr></tbody></table><p>Only first change is stored.</p><ol start=4><li>Why Use dd Instead of rsync?</li></ol><p>Disk Structure Layers</p><pre tabindex=0><code>Boot Sector
Partition Table
Filesystem
LVM Metadata
Files
</code></pre><ol start=5><li>rsync vs dd Comparison</li></ol><table><thead><tr><th>Feature</th><th>rsync</th><th>dd</th></tr></thead><tbody><tr><td>Level</td><td>File</td><td>Block</td></tr><tr><td>Bootloader backup</td><td>No</td><td>Yes</td></tr><tr><td>Disk layout</td><td>No</td><td>Yes</td></tr><tr><td>Incremental backup</td><td>Yes</td><td>No</td></tr><tr><td>Exact clone</td><td>No</td><td>Yes</td></tr></tbody></table><ol start=6><li>When to Use This Method</li></ol><ul><li>Full system recovery</li><li>Bare metal restore</li><li>LVM infrastructure backup</li><li>Golden image cloning</li></ul><ol start=7><li>When NOT to Use This Method</li></ol><ul><li>Frequent incremental backups</li><li>File-level restore needs</li><li>Very large storage environments without deduplication</li></ul><h1 id=common-failure-scenarios>Common Failure Scenarios</h1><table><thead><tr><th>Problem</th><th>Cause</th></tr></thead><tbody><tr><td>Snapshot invalid</td><td>COW space filled</td></tr><tr><td>Slow system</td><td>Snapshot active too long</td></tr><tr><td>Corrupt restore</td><td>Interrupted dd or network</td></tr></tbody></table></div><div class=singleRightBar></div></div></div><div class=footer><div class=footerLinks><a href=/>codebyred</a> |
<a href=/categories>categories</a> |
<a href=/sitemap.xml>sitemap</a></div><div class=social><a href=https://www.linkedin.com/in/md-nazmul-haque-redoan-b12a342a7/ aria-label=Facebook><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="3" fill="#0a66c2"/><path d="M6.94 8.5c.93.0 1.56-.64 1.56-1.44C8.48 6.24 7.87 5.62 6.96 5.62s-1.54.62-1.54 1.44C5.42 7.86 6.03 8.5 6.92 8.5H6.94zM5.7 9.75H8.18V18H5.7V9.75zm4.2.0h2.38v1.12H12.31C12.64 10.25 13.45 9.6 14.66 9.6c2.52.0 2.99 1.63 2.99 3.75V18H15.17V13.77C15.17 12.77 15.15 11.49 13.78 11.49c-1.39.0-1.6 1.08-1.6 2.21V18H9.9V9.75z" fill="#fff"/></svg>
</a><a href=https://twitter.com/lamawebdev aria-label=Twitter><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 0C5.372.0.0 5.372.0 12c0 5.303 3.438 9.8 8.205 11.385C8.805 23.495 9.025 23.138 9.025 22.828 9.025 22.55 9.015 21.837 9.01 20.917c-3.338.648-4.042-1.615-4.042-1.615-.546-1.384-1.335-1.747-1.335-1.747C2.545 16.838 3.717 16.854 3.717 16.854 4.922 16.944 5.555 18.082 5.555 18.082c1.07 1.818 2.837 1.32 3.497 1.028C9.162 18.337 9.463 17.828 9.805 17.555 7.145 17.284 4.343 16.237 4.343 11.553c0-1.315.462-2.39 1.212-3.223C5.42 8.056 5.033 6.814 5.67 5.096c0 0 .995-.295 3.335 1.238C9.945 6.086 10.945 5.96 11.945 5.955c1 .00499999999999989 2 .131 2.94.379 2.34-1.533 3.335-1.238 3.335-1.238C18.857 6.814 18.47 8.056 18.335 8.33c.75.833 1.212 1.908 1.212 3.223.0 4.697-2.807 5.728-5.472 5.992C14.485 17.91 14.865 18.625 14.865 19.737 14.865 21.32 14.855 22.493 14.855 22.828 14.855 23.138 15.075 23.5 15.68 23.38 20.452 21.797 24 17.303 24 12 24 5.372 18.628.0 12 0z"/></svg></a></div></div></div><script src=js/app.js></script></body></html>